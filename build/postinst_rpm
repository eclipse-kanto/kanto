systemctl_start_if_enabled () {
    if (systemctl -q is-enabled "$1"); then
        echo "Starting $1"
        systemctl start "$1" || :
    fi
}

if [ $1 -eq 1 ] && [ -x "/usr/lib/systemd/systemd-update-helper" ]; then
    # Initial installation

    # Configure Mosquitto to look for the suite-connector config file
    echo "include_dir /etc/mosquitto/conf.d" >> /etc/mosquitto/mosquitto.conf

    # Use a systemctl preset
    # instead of "systemctl enable"
    # as per Fedora's guidelines

    # Use `:` instead of `true` as this is the usual expansion of rpm scriptlets

    # If mosquitto is already running, restart it to pick up the new configuration
    /usr/lib/systemd/systemd-update-helper mark-restart-system-units suite-connector.service || :

    # If containerd and mosquitto aren't enabled, enable them
    /usr/lib/systemd/systemd-update-helper install-system-units containerd.service || :
    /usr/lib/systemd/systemd-update-helper install-system-units mosquitto.service || :

    # Enable the Kanto services
    /usr/lib/systemd/systemd-update-helper install-system-units suite-connector.service || :
    /usr/lib/systemd/systemd-update-helper install-system-units container-management.service || :
    /usr/lib/systemd/systemd-update-helper install-system-units file-upload.service || :
    /usr/lib/systemd/systemd-update-helper install-system-units software-update.service || :
    /usr/lib/systemd/systemd-update-helper install-system-units file-backup.service || :
    /usr/lib/systemd/systemd-update-helper install-system-units system-metrics.service || :

    # Start the containerd and mosquitto services, if enabled
    systemctl_start_if_enabled containerd.service || :
    systemctl_start_if_enabled mosquitto.service || :

    # Start the Kanto services, if enabled
    systemctl_start_if_enabled suite-connector.service || :
    systemctl_start_if_enabled container-management.service || :
    systemctl_start_if_enabled file-upload.service || :
    systemctl_start_if_enabled software-update.service || :
    systemctl_start_if_enabled file-backup.service || :
    systemctl_start_if_enabled system-metrics.service || :
fi
